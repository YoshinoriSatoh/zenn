---
title: IDç®¡ç† & èªè¨¼APIã® ory kratos(self-hosting)ã®ç´¹ä»‹
emoji: "ğŸ“¦" 
type: "tech" 
topics: ["ory", "kratos", "authentication"] 
published: false
---  

## æœ¬è¨˜äº‹ã®æ¦‚è¦
Webã‚¢ãƒ—ãƒªã«å¿…è¦ä¸å¯æ¬ ãªIdentityç®¡ç†(ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†)ãŠã‚ˆã³èªè¨¼æ©Ÿèƒ½ã®å°å…¥ã«ã¤ã„ã¦ã€ã©ã®ã‚ˆã†ãªé¸æŠè‚¢ãŒã‚ã‚‹ã®ã‹ã€ãã®ä¸­ã§ã‚‚ory kratos(self-hosting)é¸æŠã—ãŸèƒŒæ™¯ã€ç†ç”±ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚

ory kratosã®æ©Ÿèƒ½ã‚„ä½¿ç”¨ã™ã‚‹éš›ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã€è¨­è¨ˆTipsã¨ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## èªè¨¼å®Ÿè£…æ‰‹æ®µã®é¸æŠè‚¢
èªè¨¼æ©Ÿèƒ½ã¯Webã‚¢ãƒ—ãƒªã®å¿…é ˆè¦ä»¶ã¨è¨€ã£ã¦è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

èªè¨¼æ©Ÿèƒ½ã®å®Ÿç¾æ–¹æ³•ã¨ã—ã¦ã€ã–ã£ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªé¸æŠè‚¢ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

* å„ç¨®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å†…è”µã®èªè¨¼æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹
* IDaaSï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã‚’åˆ©ç”¨ã™ã‚‹
* ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆå‹ã®OSSã‚’åˆ©ç”¨ã™ã‚‹

ä¸€å¿œã€ç°¡å˜ã«è‡ªå‰å®Ÿè£…ã™ã‚‹ã¨ã„ã†æ‰‹æ®µã‚‚ãªã„ã“ã¨ã‚‚ãªã„ã§ã™ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒé«˜ã„ã¨æ€ã†ã®ã§ã€é¸æŠè‚¢ã‹ã‚‰ã¯å¤–ã—ã¾ã™ã€‚

ãã‚Œãã‚Œã«ã¤ã„ã¦ã€ã–ã£ã¨ãƒ¡ãƒªãƒ‡ãƒ¡ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å†…è”µã®èªè¨¼æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹
æœ€ã‚‚ãƒãƒ”ãƒ¥ãƒ©ãƒ¼ãªé¸æŠè‚¢ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã—æ˜“ãã€ãƒ¡ã‚¸ãƒ£ãƒ¼ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Œã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚å……å®Ÿã—ã¦ã„ã‚‹ãŸã‚ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç­‰ã‚‚ã—æ˜“ã„ã§ã—ã‚‡ã†ã€‚

åé¢ã€Identityãƒ‡ãƒ¼ã‚¿ãŒãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨åŒã˜DBã«ä¿ç®¡ã•ã‚Œã€èªè¨¼APIã‚‚ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ä¾å­˜ã—ã¾ã™ã€‚

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å˜ä½“ã§ã‚·ã‚¹ãƒ†ãƒ ã‚’ç¨¼åƒã•ã›ã¦ãŠã‚Šã€è² è·ã‚‚å¤§ãããªã„å ´åˆã¯ã€ç‰¹ã«å•é¡Œã¨ã¯ãªã‚Šã¾ã›ã‚“ã€‚

ã—ã‹ã—ã€ä½•ã‚‰ã‹ã®ç†ç”±ã§ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã«å¤‰æ›´ã‚’åŠ ãˆãŸããªã£ãŸå ´åˆã‚„ã€è² è·ã¸å¯¾å¿œã™ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ã€æŸ”è»Ÿæ€§ãŒä½ã„ã¨è¨€ãˆã¾ã™ã€‚

ä¾‹ãˆã°ã€æ–°è¦ã§æ§‹ç¯‰ã—ãŸAPIã‹ã‚‰æ—¢å­˜ã®èªè¨¼APIã‚’åˆ©ç”¨ã—ãŸã„å ´åˆã€æ—¢å­˜ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®èªè¨¼APIã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

å‹¿è«–ã§ããªã„ã‚ã‘ã§ã¯ãªã„ã§ã™ãŒã€ã¡ã‚‡ã£ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒæ­ªãªæ„Ÿã˜ãŒã—ã¾ã™ã€‚

ã¾ãŸã€é«˜è² è·ã¸ã®å¯¾å¿œã‚’è€ƒãˆã‚‹ã¨ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯APIã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—/ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãŒå¿…è¦ã¨ãªã‚Šã€èªè¨¼éƒ¨åˆ†ã ã‘ã®æ€§èƒ½å¢—å¼·ãŒé›£ã—ã„ã¨æ€ã„ã¾ã™ã€‚

### IDaaSï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã‚’åˆ©ç”¨ã™ã‚‹
Auth0ã‚„Amazon Cognitoã®ã‚ˆã†ãªã€IDaaSã‚’åˆ©ç”¨ã™ã‚‹é¸æŠè‚¢ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ãªã®ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

Auth0ãªã‚“ã‹ã¯ã€åˆ©ç”¨ã«ã¤ã„ã¦ã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ãŠã‚Šã€ãƒ—ãƒ©ãƒ³ã«ã‚ˆã£ã¦ã¯ã‚µãƒãƒ¼ãƒˆã‚‚å—ã‘ã‚‰ã‚Œã‚‹ãŸã‚ã€å°å…¥ãƒ»é‹ç”¨ãŒéå¸¸ã«ç°¡å˜ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ã‚ã‚‹ã§ã—ã‚‡ã†ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰èªè¨¼APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã ã‘ã§åˆ©ç”¨ã§ãã‚‹ãŸã‚ã€åˆ©ç”¨ã®æ•·å±…ã‚‚ä½ã„ã§ã™ã€‚

(Cognitoã¯ã‚„ã‚„ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ãŒé¢å€’ã ã£ãŸè¨˜æ†¶ãŒã‚ã‚Šã¾ã™ã€‚)

ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦ã¯ãã‚Œç›¸å¿œã®ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ç‚¹ã§ã™ã€‚(Auth0ãªã©)

æ–™é‡‘ä½“ç³»ã¯ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦ã‚‚å¤‰ã‚ã‚Šã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸€å®šæ•°ã‚’è¶…ãˆã‚‹ã¨ã€ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒä¸Šã®ãƒ—ãƒ©ãƒ³ã¸ç§»è¡Œã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã‚Šã€SSOç­‰ã®ç‰¹å®šã®æ©Ÿèƒ½ã‚‚ã‚ã‚‹ç¨‹åº¦ä»¥ä¸Šã®ãƒ—ãƒ©ãƒ³ã§ãªã„ã¨åˆ©ç”¨ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

å®Ÿéš›ã«åˆ©ç”¨ã—ãŸã“ã¨ãŒãªã„ãŸã‚ã€å…·ä½“çš„ãªé‡‘é¡æ„Ÿã¯ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€å¾Œã‹ã‚‰å¤§ããªã‚³ã‚¹ãƒˆã«ãªã‚Šãã†ãªæ°—ãŒã—ã¦ã€å€‹äººçš„ã«ã¯å°å…¥ã«è¶³è¸ã¿ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«ä¿ç®¡ã•ã‚Œã‚‹ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’æº€ãŸã›ãªã„å ´åˆãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆå‹ã®OSSã‚’åˆ©ç”¨ã™ã‚‹
èªè¨¼APIã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã—ã¦åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

è‡ªåˆ†ãŸã¡ã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŠã‚ˆã³é‹ç”¨ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«å‡ºã™ã“ã¨ãªãã€ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã«æ ¼ç´ã§ãã¾ã™ã€‚

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¨ã¯åˆ¥ã«èªè¨¼APIã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ãŸã‚ã€å‰è¿°ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¾å­˜å•é¡Œã‚’è§£æ±ºã§ãã‚‹ãŸã‚ã€APIæ–°è¦è¿½åŠ ç­‰ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå¤‰æ›´ã‚„ã€é«˜è² è·ã¸ã®å¯¾å¿œãŒã—ã‚„ã™ã„ã§ã™ã€‚

OSSã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€IDaaSã®ã‚ˆã†ãªã‚³ã‚¹ãƒˆã‚‚ã‹ã‹ã‚‹ã“ã¨ãªãã€ã‚¤ãƒ³ãƒ•ãƒ©è²»ç”¨ã¨ã—ã¦ã¯ã‚µãƒ¼ãƒãƒ¼ç¨¼åƒè²»ç”¨ã®ã¿ã¨ãªã‚Šã¾ã™ã€‚

ã‚³ã‚¹ãƒˆé¢ã€ãƒ‡ãƒ¼ã‚¿ä¿ç®¡å ´æ‰€ã€ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã‚„ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®è¦³ç‚¹ã‹ã‚‰ã€ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆå‹ã®OSSã‚’æ¡ç”¨ã—ãŸã„ã‚±ãƒ¼ã‚¹ã¯å¤šã„ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚ã€€

## è¤‡æ•°ãƒãƒ¼ãƒ ã«ã‚ˆã‚‹APIé–‹ç™ºã«ãŠã‘ã‚‹èªè¨¼ã®èª²é¡Œã¨è§£æ±ºæ‰‹æ®µã¨ã—ã¦ã®kratos
ä»Šå¾Œæ–°è¦ã®Webã‚¢ãƒ—ãƒªé–‹ç™ºã™ã‚‹éš›ã«ã€èªè¨¼ã‚’ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®APIã‹ã‚‰åˆ‡ã‚Šé›¢ã—ãŸè¨­è¨ˆã«ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã—ãŸã€‚

é–¢ã‚ã£ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã„ãã¤ã‹ã¯ã€è¤‡æ•°ã®ãƒãƒ¼ãƒ ãŒãã‚Œãã‚ŒAPIã‚’é–‹ç™ºã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã§é€²ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€ã“ã®å ´åˆã«èªè¨¼ã‚’ã©ã®ãƒãƒ¼ãƒ ãŒæ‹…å½“ã™ã‚‹ã®ã‹ã€ã©ã®APIã§æ‹…å½“ã™ã‚‹ã¹ããªã®ã‹ãªã©ã€èªè¨¼ã«ã¤ã„ã¦è€ƒãˆãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ãŒãŸãã•ã‚“å‡ºã¦ãã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«æ›¸ãã¨ã€ã„ã‚ã‚†ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã—ã¦ã„ã‚‹é›°å›²æ°—ãŒã‚ã‚Šã¾ã™ãŒã€æ­£ç›´ãªã¨ã“ã‚ã¡ã‚ƒã‚“ã¨ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§ãã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

ã¨ã¯ã„ãˆã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ ¹å¹¹ã«é–¢ã‚ã‚‹èªè¨¼ã«ã¤ã„ã¦ã¯ã€éƒ¨åˆ†çš„ã ã¨ã—ã¦ã‚‚ãªã‚‹ã¹ãã¡ã‚ƒã‚“ã¨ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãªæ§‹æˆã«ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã—ãŸã€‚

è¤‡æ•°ã‚ã‚‹APIã¸ã©ã®ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã®ã‹ã€ã©ã“ã§èªè¨¼ã‚¬ãƒ¼ãƒ‰ã•ã›ã‚‹ã¹ãã‹ã‚’è€ƒãˆãŸçµæœã€èªè¨¼APIã‚’ç‹¬ç«‹ã•ã›ãŸä¸Šã§ã€APIã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ãƒ‘ã‚¿ãƒ¼ãƒ³ã§èªè¨¼ã‚¬ãƒ¼ãƒ‰ã•ã›ã‚‹æ§‹æˆãŒè‰¯ã„ã¨è€ƒãˆã¾ã—ãŸã€‚

### ory kratoså°å…¥èƒŒæ™¯
ä¸Šè¨˜ã®æ§‹æˆã‚’å¿µé ­ã«ç½®ã„ãŸéš›ã«ã€ä½•ã‹ã„ã„OSSãŒãªã„ã‚‚ã®ã‹ã¨æ¢ã—ã¦ã„ã¦ã€1å¹´ã¡ã‚‡ã£ã¨å‰ãã‚‰ã„ã«è¦‹ã¤ã‘ãŸã®ãŒ ory kratos ã§ã—ãŸã€‚

kratosã¯Identityç®¡ç†ãŠã‚ˆã³èªè¨¼APIã‚’æä¾›ã™ã‚‹OSSã§ã™ã€‚ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ç‰ˆã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆç‰ˆã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚ï¼‰

èªè¨¼ã«é–¢ã™ã‚‹ä¸€é€šã‚Šã®æ©Ÿèƒ½ãŒå‚™ã‚ã£ã¦ãŠã‚Šã€MFAã‚„ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®ã‚ˆã†æ©Ÿèƒ½ã‚‚å‚™ã‚ã£ã¦ã„ã¾ã™ã€‚

å½“æ™‚ã¯ã¾ã v0.10ãã‚‰ã„ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã—ãŸãŒã€ç¾åœ¨ã¯v1.0.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚

ï¼ˆã“ã“åŠå¹´ãã‚‰ã„æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã¾ã›ã‚“ãŒã€[masterãƒ–ãƒ©ãƒ³ãƒã«ã¯è¿½åŠ æ©Ÿèƒ½ã‚„ä¸å…·åˆä¿®æ­£ãŒå¤šãã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚](https://github.com/ory/kratos/blob/master/CHANGELOG.md))

èªè¨¼ã«é–¢ã™ã‚‹æ©Ÿèƒ½çš„ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚‚ä»Šå¾Œå…¥ã£ã¦ã„ãã¨è€ƒãˆã‚‹ã¨ã€kartosã‚’å°å…¥ã—ã¦ãŠãæ©æµãŒæœŸå¾…ã§ãã¾ã™ã€‚

ã¾ãŸã€Passkeyã®ã‚ˆã†ãªæ–°ã—ã„æ©Ÿèƒ½ã«ã¤ã„ã¦ã‚‚ã€ç¾æ™‚ç‚¹ã¯ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆç‰ˆã§ã¯æœªå®Ÿè£…ã®ã‚ˆã†ã§ã™ãŒã€ä»Šå¾Œå®Ÿè£…ã•ã‚Œã‚‹ã“ã¨ã‚‚å€‹äººçš„ã«æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚

([Passkeyã¯ã‚¯ãƒ©ã‚¦ãƒ‰ç‰ˆã«ã¯æ­è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™](https://www.ory.sh/docs/kratos/passwordless/passkeys))

### kratosã®æ©Ÿèƒ½
kratosã¯ã€IDç®¡ç†ãŠã‚ˆã³èªè¨¼ã«å¿…è¦ãªä¸€é€šã‚Šã®API/æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã€ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ã®æ¤œè¨¼ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¾©æ—§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
* ä¸Šè¨˜ã®å„ç¨®æ©Ÿèƒ½å®Ÿè¡Œæ™‚ã®ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹ãƒ•ãƒƒã‚¯å‡¦ç†ã‚’è¨˜è¿°å¯èƒ½
* æœ¬äººæ¤œè¨¼ã‚„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¾©æ—§/æ¤œè¨¼æ™‚ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚‚å¯èƒ½)
* MFA
* ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚µã‚¤ãƒ³ã‚¤ãƒ³
* ã‚¢ãƒ‰ãƒŸãƒ³ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«å†…è”µã•ã‚Œã¦ã„ã‚‹èªè¨¼æ©Ÿèƒ½ã¨åŒç­‰ä»¥ä¸Šã®æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

### kratosã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
kratosã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚„ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¾©æ—§ã¨ã„ã£ãŸã€[SelfService flow](https://www.ory.sh/docs/kratos/self-service)ã¨å‘¼ã°ã‚Œã‚‹å®Ÿè£…ãŒãªã•ã‚Œã¦ãŠã‚Šã€ã“ã®ä»•æ§˜ãŒNISTã‚„IFTFã€Microsoft Researchã€Google Researchã€Trou Huntã«ã‚ˆã£ã¦ç¢ºç«‹ã•ã‚ŒãŸãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åŸºã¥ã„ã¦ã„ã‚‹ã¨ã®ã“ã¨ã§ã™ã€‚

SelfService flowã«å¾“ã†ã“ã¨ã§ã€å„ç¨®æ”»æ’ƒã‚„CSRFã«å¯¾ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒç¢ºä¿ã•ã‚Œã¾ã™ã€‚

ãã®ä»–ã€å„ç¨®æ©Ÿèƒ½ã®å®Ÿè£…ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã«é–¢ã—ã¦[NISTã®ãƒ‡ã‚¸ã‚¿ãƒ«IDã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«æº–æ‹ ã—ã¦ã„ã¾ã™ã€‚](https://www.ory.sh/docs/kratos/concepts/security))

### kratosã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
kartosã¯ã€DBã«ã®ã¿çŠ¶æ…‹ã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€[ã‚³ãƒ³ãƒ†ãƒŠã®æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã£ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãŒå¯èƒ½ã§ã™ã€‚](https://www.ory.sh/docs/self-hosted/operations/scalability)

DBã®è² è·ã«ã¤ã„ã¦ã¯æ°—ã«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã™ãŒã€kratosã®DBã®ã¿ã‚’å¢—å¼·ã™ã‚‹ãªã©ã€èªè¨¼éƒ¨åˆ†ã®ã¿ã‚’ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ/ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

DBã¯ã€MySQLã€PostgreSQLã€CockroachDBã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

CockroachDBã«ã¤ã„ã¦ã¯è©³ã—ããªã„ã§ã™ãŒã€ã‚‚ã—CockroachDBã‚’å°å…¥ã§ãã‚‹ã®ã§ã‚ã‚Œã°ã€DBã‚‚ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã§ãã‚‹ãŸã‚ã€èªè¨¼éƒ¨åˆ†ã‚’ç´°ã‹ãã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šãã†ã§ã™ã€‚

ä½¿ã£ã¦ã¿ãŸæ„Ÿè§¦ã§ã¯ã€kratosã¯Golangã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€èµ·å‹•ãŒæ—©ã„ãŸã‚ãƒ‡ãƒ—ãƒ­ã‚¤ç­‰ã®éš›ã«éå¸¸ã«ä½¿ã„ã‚„ã™ã‹ã£ãŸã§ã™ã€‚

### IAPã®æ§‹æˆè¦ç´ ã¨ã—ã¦ã®kratos
oryã¯ã€kratosã®ä»–ã«å¹¾ã¤ã‹ã®OSSã‚’é–‹ç™ºã—ã¦ãŠã‚Šã€ãã®ä¸­ã®ä¸€ã¤ã«ory oathkeeperã¨ã„ã†ãƒ—ãƒ­ã‚­ã‚·ãŒã‚ã‚Šã¾ã™ã€‚

æ­£ç¢ºã«ã¯ã€Identity & Access Proxy (IAP)ã¨ã„ã†ã‚‚ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œæŸ»ã—ã€èªè¨¼ã•ã‚Œã¦ã„ã‚Œã°å¾Œæ®µã®APIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€ã™ã‚‹ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

oathkeeperè‡ªä½“ãŒIAPã¨ã—ã¦æŒ¯ã‚‹èˆã†ã“ã¨ã‚‚ã§ãã¾ã™ã—ã€Traefikã®ã‚ˆã†ãªå°‚ç”¨ã®ãƒ—ãƒ­ã‚­ã‚·(ã‚¨ãƒƒã‚¸ãƒ«ãƒ¼ã‚¿ãƒ¼)ã‹ã‚‰oathkeeperã‚’å‘¼ã³å‡ºã—ã¦ã€IAPã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚ã§ãã€kratosã¨ç›¸æ€§ã‚‚è‰¯ã„ã§ã™ã€‚

## kratosãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æ¦‚è¦
kratosã‚’ä½¿ç”¨ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã€APIã¸ã®å—ã‘æ¸¡ã—ãŠã‚ˆã³APIå´ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æ¦‚è¦ã‚’æã„ã¦ã¿ã¾ã—ãŸã€‚

![](https://github.com/YoshinoriSatoh/zenn/blob/master/images/kartos_usecase_overview/kratos_usecase_overview.png?raw=true)
*kratosãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æ¦‚è¦*

å·¦å´ã®æ ãŒWeb/Native Appã€çœŸã‚“ä¸­ã«kratosã¨ãã®å³å´ã«kratos DBã€ä¸‹å´ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯APIã¨ãã®å³å´ã«APIç”¨ã®DBã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

kratosã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã€ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¾©æ—§ã¨ã„ã£ãŸã€SelfService flowã¨å‘¼ã°ã‚Œã‚‹å®Ÿè£…ãŒãªã•ã‚Œã¦ãŠã‚Šã€è©³ç´°ã¯å‰²æ„›ã—ã¦ã„ã¾ã™ãŒã€å›³ä¸­ã«å„SelfService flowã¨é–¢é€£ã™ã‚‹æµã‚Œã¨DBå†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

kartosã¯ã€Webã‚¢ãƒ—ãƒª(ãƒ–ãƒ©ã‚¦ã‚¶)ãŠã‚ˆã³ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‹ã‚‰ã®åˆ©ç”¨ãŒæƒ³å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¸Šå›³ä¸­ã§ã¯ã¾ã¨ã‚ã¦è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

Webã‚¢ãƒ—ãƒª(ãƒ–ãƒ©ã‚¦ã‚¶)ã¨ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã§ã¯ã€ç´°ã‹ã„ãƒ•ãƒ­ãƒ¼ã¯ç•°ãªã‚Šã¾ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®æµã‚Œã§èª¬æ˜ã—ã¾ã™ã€‚
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
3. ãƒ­ã‚°ã‚¤ãƒ³
4. ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
5. èªè¨¼ãŒå¿…è¦ãªAPIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚

ç™»éŒ²ã™ã‚‹Identifierã«ç›¸å½“ã™ã‚‹é …ç›®ã¯ã€kratosã«è¨­å®šã™ã‚‹[Identity schema](https://www.ory.sh/docs/kratos/manage-identities/customize-identity-schema)ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ä¸Šå›³ã®ã‚ˆã†ã«ã€emailã‚’Identifierã¨ã—ã¦ä½¿ç”¨ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹èªè¨¼ã‚’è¡Œã†å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè¨˜è¿°ã«ãªã‚Šã¾ã™ã€‚

([Json schema](https://json-schema.org/)ã§è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚)

```json
{
  "email": {
    "type": "string",
    "format": "email",
    "title": "E-Mail",
    "ory.sh/kratos": {
      "credentials": {
        "password": {
          "identifier": true
        }
      },
      "verification": {
        "via": "email"
      },
      "recovery": {
        "via": "email"
      }
    }
  },
  "nickname": {
    "type": "string",
    "title": "nickname"
  },
  "birthdate": {
    "type": "string",
    "title": "birthdate"
  }
}
```

ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰emailé …ç›®ã‚’å…¥åŠ›ã—ã€kratosã®Registration APIã‚’å‘¼ã³å‡ºã™ã¨ã€ä¸Šè¨˜ã®schemaã«å¾“ã£ãŸidentityãŒkratosã®DBã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚

ç™»éŒ²ã•ã‚ŒãŸidentityã«å¯¾ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ãŒã€Emailã‚’Identifierã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### traitsã¨ãã®æ›´æ–°
ä¸Šè¿°ã®shchemaã€traitsã¨å‘¼ã°ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†è‡ªèº«ã§ç™»éŒ²ã‚„æ›´æ–°ãŒå¯èƒ½ãªé …ç›®ã§ã™ã€‚

identifierã§ã‚ã‚‹emailä»¥å¤–ã«ã‚‚ã€nicknameã¨birthdateã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã¯ã€èªè¨¼ã®identifierã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å›ºæœ‰ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã¨ã—ã¦ã€traitsã«ä¿ç®¡ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚‰ã®é …ç›®ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã«ä¸€ç·’ã«ç™»éŒ²ã‚‚ã§ãã¾ã™ã—ã€traitsã‚’æ›´æ–°å¯èƒ½ãªæ©Ÿèƒ½(sefl-service settings flow)ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã§æ›´æ–°å¯èƒ½ã§ã™ã€‚

(å›³ä¸­ã§ã¯SelfService Settingsã¯å‰²æ„›ã—ã¦ã„ã¾ã™ã€‚)

### ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
Emailã‚’Identifierã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å¾Œã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚

kratosã®è¨­å®šã«ã‚ˆã£ã¦ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ¤œè¨¼å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã§ãªã‘ã‚Œã°ã€ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ãªã„ã‚ˆã†ãªè¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚

åŸºæœ¬çš„ã«ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼ãŒå¿…é ˆã¨è€ƒãˆãŸæ–¹ãŒè‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

kartosã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã‚‚å†…åŒ…ã•ã‚Œã¦ãŠã‚Šã€é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯kratos DBã®courier_messagesãƒ†ãƒ¼ãƒ–ãƒ«ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚

ãƒ¡ãƒ¼ãƒ«å†…å®¹ã¯templateã§ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

templateã¯go-templateãŒä½¿ç”¨ã•ã‚Œã¦ãŠã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¸­ã§æ¦‚è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Identityæƒ…å ±ã‚’å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã«ã€6æ¡ã®æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ãŒè¨˜è¼‰ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ãŒå±Šãã¾ã™ã€‚

ã“ã®æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã‚’verification formã¸å…¥åŠ›ã—ã€kartosã®Verification APIã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã€ã¾ãŸæœ‰åŠ¹æœŸé™å†…ã§ã‚ã‚Œã°ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã™ã€‚

### ãƒ­ã‚°ã‚¤ãƒ³
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼å®Œäº†å¾Œã«ç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Emailã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€kratosã®Login APIã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã€kratos DBã®sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚

### ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ã€whoamiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã§ãã¾ã™ã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†æ–¹å¼ã¯ã€Webã‚¢ãƒ—ãƒª(ãƒ–ãƒ©ã‚¦ã‚¶)ã¨ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã§ç•°ãªã‚Šã¾ã™ã€‚
* Webã‚¢ãƒ—ãƒª(ãƒ–ãƒ©ã‚¦ã‚¶)ã¯Cookieãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
* ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã¯ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚

Cookieã§ã‚ã‚‹ãŸã‚ã€ç‰¹ã«æ„è­˜ãœãšã¨ã‚‚ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚

ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã®å ´åˆã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚

Cookieã¨ç•°ãªã‚Šã€ä»¥é™ã®APIã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«ã€æ„è­˜ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ã—ã¦å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### èªè¨¼ãŒå¿…è¦ãªAPIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
ä¸Šè¿°ã®é€šã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã®å ´åˆã¯ãƒ˜ãƒƒãƒ€ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ã—ã¦ã€APIã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

APIå´ã¯ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç­‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã€æœ‰åŠ¹ã§ã‚ã‚Œã°APIã‚’å®Ÿè¡Œã—ã€ãã†ã§ãªã‘ã‚Œã°401ã‚¨ãƒ©ãƒ¼ã‚’è¿”å´ã—ã¾ã™ã€‚

APIã‹ã‚‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æ€§ç¢ºèªã«ã¯ã€kratosã®whoamiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

(UIã‹ã‚‰å®Ÿæ–½ã™ã‚‹å ´åˆã¨åŒæ§˜ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚)

ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ã§ã‚ã‚Œã°ã€Identityæƒ…å ±ã‚‚å«ã‚“ã Sessionæƒ…å ±ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚

Sessionæƒ…å ±ã®ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

traitsã‚„metadataã®

```json
{
  "session": {
    "id": "d56e59d8-742c-4ce1-a230-8cbf8cc00383",
    "active": true,
    "expires_at": "2024-01-30T02:33:34.377841929Z",
    "authenticated_at": "2024-01-29T02:33:34.377841929Z",
    "authenticator_assurance_level": "aal1",
    "authentication_methods": [
      {
        "method": "password",
        "aal": "aal1",
        "completed_at": "2024-01-29T02:33:34.377833887Z"
      }
    ],
    "issued_at": "2024-01-29T02:33:34.377841929Z",
    "identity": {
      "id": "20baf766-427e-4241-b6be-1cb95dfd2430",
      "schema_id": "user_v1",
      "schema_url": "http://localhost:4533/schemas/dXNlcl92MQ",
      "state": "active",
      "state_changed_at": "2024-01-23T14:07:33.475358Z",
      "traits": {
        "email": "user1@ysexample.com"
      },
      "verifiable_addresses": [
        {
          "id": "b3bee943-b9bc-4c75-93ad-fc351a709c7a",
          "value": "user1@ysexample.com",
          "verified": true,
          "via": "email",
          "status": "completed",
          "verified_at": "2024-01-24T10:00:43.604377Z",
          "created_at": "2024-01-23T14:07:33.47736Z",
          "updated_at": "2024-01-23T14:07:33.47736Z"
        }
      ],
      "recovery_addresses": [
        {
          "id": "ea8070ca-3177-477e-b28c-cdbb48284720",
          "value": "user1@ysexample.com",
          "via": "email",
          "created_at": "2024-01-23T14:07:33.478646Z",
          "updated_at": "2024-01-23T14:07:33.478646Z"
        }
      ],
      "metadata_public": null,
      "created_at": "2024-01-23T14:07:33.476249Z",
      "updated_at": "2024-01-23T14:07:33.476249Z"
    },
    "devices": [
      {
        "id": "c8ee6e7c-d77c-471b-afa3-2fdd17333d83",
        "ip_address": "192.168.65.1:38512",
        "user_agent": "curl/7.87.0",
        "location": ""
      }
    ]
  }
}
```

## kratosã¨å‘¨è¾ºã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã®Tips

### kratos Identityã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³DBã®ãƒ‡ãƒ¼ã‚¿ã¨ã®ç´ä»˜ã‘
kratosã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³APIã§ã¯DBãŒåˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®ãŸã‚ã€kratos DBã®Identityã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®DBå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®æƒ…å ±ã‚’ç´ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³DBã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ããƒ‡ãƒ¼ã‚¿ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒã«kratosã®Identity IDã‚’æŒãŸã›ã‚‹ã®ãŒã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ã§ã™ã€‚

kratosã®Identity IDã¯UUIDå½¢å¼ã§ã™ã€‚

kratosã®DBã«ã¯ã€MySQLã¨PostgreSQLã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€PostgreSQLã«ã¯UUIDå‹ãŒå­˜åœ¨ã—ã€UUIDã‚’æ‰±ã„ã‚„ã™ã„ã§ã™ã€‚

(CockroachDBã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã¾ã™ãŒã€ã“ã‚Œã«ã¯ã‚ã¾ã‚Šè©³ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚)

MySQLã§ã‚‚æ–‡å­—åˆ—å‹ã§UUIDã‚’æ‰±ã†ã“ã¨ã¯ã§ãã¾ã™ãŒã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ãªæ‡¸å¿µãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã«ã¤ã„ã¦ã®è©³ã—ã„ã¨ã“ã‚ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

[MySQLã§ãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ã‚’UUIDã«ã™ã‚‹å‰ã«çŸ¥ã£ã¦ãŠã„ã¦æ¬²ã—ã„ã“ã¨](https://techblog.raccoon.ne.jp/archives/1627262796.html)

MySQL8ã§ã¯ã€UUID_TO_BINã€BIN_TO_UUIDé–¢æ•°ãŒã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸãŸã‚ã€BINALYå‹ã«å¤‰æ›ã—ã¦æŒã¤ã“ã¨ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ãªæ‡¸å¿µã¯è§£æ¶ˆã•ã‚Œãã†ã§ã™ãŒã€ä»£ã‚ã‚Šã«DBã‚’å‚é›†ã™ã‚‹éš›ã«ã€ã¡ã‚‡ã£ã¨é¢å€’ã•ãŒæ®‹ã‚Šã¾ã™ã€‚

ï¼ˆBIN_TO_UUIDã‚’SELECTã«å«ã‚ã‚Œã°ã„ã„ã ã‘ã§ã¯ã‚ã‚‹ã®ã§ã™ãŒã€å€‹äººçš„ã«ã¯ãã®ã¡ã‚‡ã£ã¨ãŒã‚ã‚Šã¨é¢å€’ã«æ„Ÿã˜ã¦ã—ã¾ã„ã¾ã™ã€‚ï¼‰

### traitsã«æ ¼ç´ã™ã‚‹ã¹ãé …ç›®

karatosã®SelfService Settings Flowã«ã‚ˆã£ã¦å®‰å…¨ã«æ›´æ–°å¯èƒ½ã§ã‚ã‚‹ãŸã‚ã€traitsã«ã¯ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ãªé …ç›®ã‚’æŒãŸã›ã‚‹ã®ãŒè‰¯ã„ã¨ã®ã“ã¨ã§ã™ã€‚

traitsã«æ ¼ç´ã™ã‚‹ã¹ããƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ã‚ˆã‚‹ã¨

> Do not add too many fields to your identities. Keep the number of fields well below 15.

IDã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¢—ã‚„ã—ã™ããªã„ã“ã¨ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ•°ã¯15ä»¥ä¸‹ã«ã—ã¾ã—ã‚‡ã†ã€‚

> Do not store business logic in your identities. Store this information in other systems. This includes credit card information, shipping addresses, shopping cart items, or user preferences.

ãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ä¿å­˜ã—ãªã„ã§ãã ã•ã„ã€‚ã“ã‚Œã‚‰ã®æƒ…å ±ã¯ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã¯ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±ã€é…é€å…ˆä½æ‰€ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆé …ç›®ã€ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãŒå«ã¾ã‚Œã¾ã™ã€‚

> Do store profile data that is used across your system. This includes the usernames, email addresses, phone numbers, first names, and last names.

ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€é›»è©±ç•ªå·ã€å§“ã€åãŒå«ã¾ã‚Œã¾ã™ã€‚

ã¨ã®ã“ã¨ã§ã™ã€‚

ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«é–¢é€£ã—ãªã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ã™ã‚‹é …ç›®ã¯traitsã«æŒãŸã›ã€ãã‚Œä»¥å¤–ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³DBå´ã«æŒãŸã›ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã­ã€‚

### metadata
ã¡ãªã¿ã«ã€metadata_public, metadata_adminã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã§æ›´æ–°ä¸å¯èƒ½ãªé …ç›®ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

metadata_publicã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å«ã¾ã‚Œã‚‹æƒ…å ±ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚ç…§å¯èƒ½ã§ã™ã€‚

ä¸€æ–¹ã€metadta_adminã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å«ã¾ã‚Œã¦ãŠã‚‰ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚ç…§ãŒä¸å¯èƒ½ãªé …ç›®ã§ã™ã€‚

ä¾‹ã¨ã—ã¦ã€metadata_publicã«roleã¨ã„ã†é …ç›®ã‚’æŒãŸã›ã€ãƒ­ãƒ¼ãƒ«ã«ã‚ˆã£ã¦èªå¯åˆ¶å¾¡ã‚’è¡Œã†ãªã©ã®å®Ÿè£…ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

ã“ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã§ã¯ãƒ­ãƒ¼ãƒ«ã¯è¨­å®šã§ããªã„ï¼ˆã•ã›ãŸããªã„ï¼‰ãŸã‚ã€ã‚¢ãƒ‰ãƒŸãƒ³æ¨©é™ã‚’æŒã¤ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒkratosã®Adminç³»APIã‚’ä½¿ç”¨ã—ã¦ã€metadata_publicã‚’æ›´æ–°ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## ä¸€æ—¦ã¾ã¨ã‚
IDç®¡ç†ãŠã‚ˆã³èªè¨¼æ©Ÿèƒ½å°å…¥ã®é¸æŠè‚¢ãŠã‚ˆã³ã€è¤‡æ•°ã®APIãŒæ§‹ç¯‰ã•ã‚Œã‚‹çŠ¶æ³ä¸‹ã§ã€ory kratosé¸æŠã—ãŸèƒŒæ™¯ã€ç†ç”±ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã—ãŸã€‚

kratosã®ä¸€é€šã‚Šã®æ©Ÿèƒ½ã‚„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æ¦‚è¦ã€è¨­è¨ˆTipsã«ã¤ã„ã¦ã‚‚ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ç§è‡ªèº«ã€2ã¤ã»ã©ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ory kratosã‚’å°å…¥ã—ã¦ã„ã¾ã—ã¦ã€æœ€åˆã®ä½¿ã„æ–¹ã®ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã¯å°‘ã—å¤§å¤‰ã§ã—ãŸãŒã€ãã“ã‚’ä¹—ã‚Šè¶Šãˆã¦ã—ã¾ãˆã°ä¾¿åˆ©ã«ä½¿ç”¨ã§ãã‚‹å°è±¡ã§ã™ã€‚

NISTæº–æ‹ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦³ç‚¹ã§å®Ÿè£…ã•ã‚Œã¦ã„ãŸã‚Šã€Golangãƒ™ãƒ¼ã‚¹ã‹ã¤çŠ¶æ…‹ç®¡ç†ã®ä¾å­˜å…ˆãŒDBã®ã¿ã¨ã‚·ãƒ³ãƒ—ãƒ«ãªä½œã‚Šã§ã‚‚ã‚ã‚‹ãŸã‚ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦³ç‚¹ã§ã‚‚ä½¿ã„ã‚„ã™ã„ã§ã™ã€‚

ã¾ã ã¾ã ã€å…¨ã¦ã®æ©Ÿèƒ½ã‚’ä½¿ã„è¾¼ã‚“ã§ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã™ãŒã€ä»Šå¾Œã‚‚kratosã‚’ä½¿ã„è¾¼ã¿ã€ä½¿ã„æ–¹ã‚„å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«ã«ã¤ã„ã¦ã‚‚ç´¹ä»‹ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## SelfService flowã®ã‚µãƒ³ãƒ—ãƒ«
æ—©é€Ÿã§ã™ãŒã€ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«kratosã®self-service flowã®ã”ãç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

https://github.com/YoshinoriSatoh/kratos_selfservice_example

docker compose upã§ã€kratosã€DB, ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒã®mailslurperãŒèµ·å‹•ã—ã¾ã™ã€‚

```
docker compose up
```

kratosã«å¯¾ã—ã¦ã€SelfService flowã®å„ç¨®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

è©³ç´°ã¯çœãã¾ã™ãŒã€ä¸€éƒ¨ã ã‘ã–ã£ã¨ç´¹ä»‹ã—ã¾ã™ã€‚

### Registration flow (browser)

ä¾‹ãˆã°ã€Browser flowã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```
./scripts/registration_browser.sh
```

ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸­ã§ã€ä»¥ä¸‹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚
1. Registration flowã®åˆæœŸåŒ–API
2. Registration flowã®å®Ÿè¡ŒAPI
3. Verification codeå…¥åŠ›å¾…ã¡
4. Verification flow(mothod: code)ã®å®Ÿè¡ŒAPI 


ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€1ã¨2ã¾ã§å®Ÿè¡Œã•ã‚Œã€3ã§ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```
please input code emailed to you:  
```

ã“ã“ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:4436 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](https://github.com/YoshinoriSatoh/zenn/blob/master/images/kartos_usecase_overview/mailslurper.png?raw=true)

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ã®ãŸã‚ã®æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ãŒé€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã€ŒPlease verify your email addressã€ã¨ã„ã†ãƒ¡ãƒ¼ãƒ«ãŒå±Šã„ã¦ã„ã¾ã™ã€‚

ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ä¸­ã«ã€6æ¡ã®æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å…¥åŠ›ã—ã¾ã™ã€‚

å…¥åŠ›ã™ã‚‹ã¨ã€4ã®flowã®å®Ÿè¡ŒAPIãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200 OKãŒè¿”å´ã•ã‚Œã‚Œã°OKã§ã™ã€‚

### Login flow (browser)

æ¬¡ã«ã€ç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã¾ã™ã€‚

```
./scripts/login_browser.sh
```

ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸­ã§ã€ä»¥ä¸‹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚
1. Login flowã®åˆæœŸåŒ–API
2. Login flowã®å®Ÿè¡ŒAPI

å®Ÿè¡Œå¾Œã€2.ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä»¥ä¸‹ã®ã‚ˆã†ã«è¿”å´ã•ã‚Œã¾ã™ã€‚

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«sessionãŒè¿”å´ã•ã‚Œã‚‹ã¨åŒæ™‚ã«ã€browser flowã§ã‚ã‚‹ãŸã‚ã€session cookieã‚‚ä»˜ä¸ã•ã‚Œã¾ã™ã€‚

bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯ã€cookieã¯ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿ç®¡ã—ã¦ãŠã‚Šã€`.cookie_session`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ã€`kratos_session`ã¨ã„ã†ã‚­ãƒ¼ã®cookieãŒä¿ç®¡ã•ã‚Œã¾ã™ã€‚

```json
{
  "session": {
    "id": "2eb50f70-3a23-4067-99f6-9fd645686880",
    "active": true,
    "expires_at": "2024-01-30T13:53:23.622162292Z",
    "authenticated_at": "2024-01-29T13:53:23.622162292Z",
    "authenticator_assurance_level": "aal1",
    "authentication_methods": [
      {
        "method": "password",
        "aal": "aal1",
        "completed_at": "2024-01-29T13:53:23.6221575Z"
      }
    ],
    "issued_at": "2024-01-29T13:53:23.622162292Z",
    "identity": {
      "id": "eedb3b8d-3ecf-4946-9f7b-440f65ea5fca",
      "schema_id": "user_v1",
      "schema_url": "http://localhost:4533/schemas/dXNlcl92MQ",
      "state": "active",
      "state_changed_at": "2024-01-29T12:37:10.960541Z",
      "traits": {
        "email": "1@local"
      },
      "verifiable_addresses": [
        {
          "id": "5993eb3c-34e9-444b-930c-1234df761b59",
          "value": "1@local",
          "verified": true,
          "via": "email",
          "status": "completed",
          "verified_at": "2024-01-29T13:36:18.727252Z",
          "created_at": "2024-01-29T12:37:10.964533Z",
          "updated_at": "2024-01-29T12:37:10.964533Z"
        }
      ],
      "recovery_addresses": [
        {
          "id": "61e32d2c-ff31-46d9-9c26-70da154ebdc4",
          "value": "1@local",
          "via": "email",
          "created_at": "2024-01-29T12:37:10.965891Z",
          "updated_at": "2024-01-29T12:37:10.965891Z"
        }
      ],
      "metadata_public": {
        "roles": [
          "admin"
        ]
      },
      "created_at": "2024-01-29T12:37:10.962889Z",
      "updated_at": "2024-01-29T12:37:10.962889Z"
    },
    "devices": [
      {
        "id": "83ec820f-20b7-4f52-95b2-ebf184da3ecb",
        "ip_address": "192.168.65.1:55593",
        "user_agent": "curl/7.87.0",
        "location": ""
      }
    ]
  }
}
```

cookieãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
```
# Netscape HTTP Cookie File
# https://curl.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

#HttpOnly_.localhost	TRUE	/	FALSE	1706622802	kratos_session	MTcwNjUzNjQwM3xRZWpxSXExVVl1ZlpncGc3VEZoQTRwcklrLWJpTk9tR2xUTE1idXpRQ2xEbWpIX1VITjA1ZkhHdmttZDVEWURfYUE3SXU5dkFRNmQ3dmJwQ2pTbEhHbTJla1MzRWk0TV9UY2xfS095Mm5aVFNIUm1famVESExsd01nbHlGV2lQT3pBSzB3eUlRd3Vsa3dkaFE0VUdXa3lKRFItQVU5dkM1bXIxWDl2dkZET0dZR2JEWkI3ckdIOEk0ZUxVdy14ZEg2WlNiaXNWZVdUR0puSXJGanIyOHZqZS1jYXY2RFNHZHZCN2FZX2ZKWnZyTXpqWGVuZ0JjTUE3TEFaQjRlSHhVVkFMbFV6VFJ2Y2UwR0wySlRybVRwdz09fMUIK6aQEukbx3UmWsmj7Y9Vhs4QYO2vG5aZCmMSMGbF
#HttpOnly_.localhost	TRUE	/	FALSE	1738072403	csrf_token_0c666b0902e91df80a1a31234b66208e51e130bbc39abed17c5efa1830e47544	3myyvq+HAIPBmCi78b8BqcwgtOT50lkquTg6Nk+Bwu0=

```

### whoami (browser)

ä¸Šè¨˜ã§å–å¾—ã—ãŸkratos_sessionã‹ã‚‰ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€/sessions/whoamiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

/sessions/whoamiã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€SPAã«ãŠã‘ã‚‹UIå´ã‹ã‚‰ã‚‚å‘¼ã³å‡ºã›ã¾ã™ã—ã€APIå´ã§cookieãŒä»˜ä¸ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ãªã‚‚ã®ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã‚‚ä½¿ç”¨ã—ã¾ã™ã€‚

```
./scripts/whoami_browser.sh
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ã€Sessionæƒ…å ±ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚(ãƒ­ã‚°ã‚¤ãƒ³ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨æ®†ã©åŒæ§˜)

```json
{
  "id": "2eb50f70-3a23-4067-99f6-9fd645686880",
  "active": true,
  "expires_at": "2024-01-30T13:53:23.622162Z",
  "authenticated_at": "2024-01-29T13:53:23.622162Z",
  "authenticator_assurance_level": "aal1",
  "authentication_methods": [
    {
      "method": "password",
      "aal": "aal1",
      "completed_at": "2024-01-29T13:53:23.6221575Z"
    }
  ],
  "issued_at": "2024-01-29T13:53:23.622162Z",
  "identity": {
    "id": "eedb3b8d-3ecf-4946-9f7b-440f65ea5fca",
    "schema_id": "user_v1",
    "schema_url": "http://localhost:4533/schemas/dXNlcl92MQ",
    "state": "active",
    "state_changed_at": "2024-01-29T12:37:10.960541Z",
    "traits": {
      "email": "1@local"
    },
    "verifiable_addresses": [
      {
        "id": "5993eb3c-34e9-444b-930c-1234df761b59",
        "value": "1@local",
        "verified": true,
        "via": "email",
        "status": "completed",
        "verified_at": "2024-01-29T13:36:18.727252Z",
        "created_at": "2024-01-29T12:37:10.964533Z",
        "updated_at": "2024-01-29T12:37:10.964533Z"
      }
    ],
    "recovery_addresses": [
      {
        "id": "61e32d2c-ff31-46d9-9c26-70da154ebdc4",
        "value": "1@local",
        "via": "email",
        "created_at": "2024-01-29T12:37:10.965891Z",
        "updated_at": "2024-01-29T12:37:10.965891Z"
      }
    ],
    "metadata_public": {
      "roles": [
        "admin"
      ]
    },
    "created_at": "2024-01-29T12:37:10.962889Z",
    "updated_at": "2024-01-29T12:37:10.962889Z"
  },
  "devices": [
    {
      "id": "83ec820f-20b7-4f52-95b2-ebf184da3ecb",
      "ip_address": "192.168.65.1:55593",
      "user_agent": "curl/7.87.0",
      "location": ""
    }
  ]
}
```

### ãŠã‚ã‚Šã«
ä»¥ä¸Šã€ory kratosã¨ãã®å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«ã®ç´¹ä»‹ã§ã—ãŸã€‚

ä»Šå¾Œã‚‚kratosã®æ©Ÿèƒ½ã‚„ãã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã€ç™ºä¿¡ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

(Passkeyå®Ÿè£…ã•ã‚Œã¦ã»ã—ã„ãªã)
