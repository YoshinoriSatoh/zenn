---
title: "EKSのコンテキスト切り替え事故を可能な限り防ぐ"
emoji: "😸"
type: "tech"
topics: ["aws", "eks"]
published: false
---

## コンテキスト切り替え忘れのヒヤリハット
EKSクラスタへkubectlを実行する際、コンテキストをうっかり間違えてしまって、ひやっとした経験はありませんでしょうか？

GitOpsを構築していれば、kubectlで直接apply等の操作を行う機会はなくなるはずではありますが、とはいえいざという時のために、kubectlによる操作環境も構築しておきたいところです。

なるべく安全にkubectlを操作できる環境を構築してみました。

## 最低限のkubectl環境

EKSのAPIサーバは、パブリック・プライベートもしくはその両方のアクセス許可を設定可能です。

プライベートアクセスを許可している場合はVPC内のEC2インスタンスやVPN接続から、パプリックアクセスも許可している場合はローカルマシン等からインターネット経由で、kubectlを実行できます。

アクセスポリシーによってkubectlを実行する環境は変わりますが、いずれも一つのマシンにて複数のEKSクラスターを切り替えて実行可能です。

このため、ユーザごとの権限さえ適切に管理されていれば、kubectl実行時にコンテキストを切り替えることで、実行環境としては充分そうです。

![](https://storage.googleapis.com/zenn-user-upload/om0q2v6xgqg89o53spotpudacbol)

## 手動操作でコンテキストを切り替える問題点

ここで以下の課題が見えてきました。

* コンテキスト切り替えは手動操作
* この手動操作を絶対に間違えてはならない
* 間違えた際の被害が大きい

コンテキストを間違ってapplyしてしまうと、サービスがダウンしたり、突然別バージョンで起動するなど、広範囲にわたって被害が及びます。

今現在どのコンテキストであるかは、勿論コマンドで確認可能ですが、これも手動操作・手動確認です。

何かしら防ぐ仕組みがないと、ちょっと怖いところです。

![](https://storage.googleapis.com/zenn-user-upload/5idgfhsr10vawo7zipbtpnflbpoo)

## クラスター毎のkubectl専用インスタンス
検討した結果、泥臭い手法ではありますが、以下のようにEKSクラスター毎にkubectl専用のEC2インスタンス(以下kubectlインスタンス)を構築するようにしてみました。

要点は以下の通りです。

* kubectlインスタンスは対応する一つのクラスターへのコンテキストしか持たない
* クラスターのadmin権限はkubectlインスタンスにしか持たせない (systems:master)
* 各IAMユーザは閲覧のみ可能な権限を割り当てる (viewer)
* kubectlインスタンスはprivate subnetに配置し、インターネットインバウンドを持たない
* kubectlインスタンスにはSSM Session Managerで接続する
* kubectlインスタンスは、EventBridgeによって日時でスケジュール停止する

## そもそもコンテキスト切り替えの必要をなくす

kubectlインスタンスは、対応する一つのクラスターへのコンテキストしか持ちません。

このため、そもそもコンテキス誤りや切り替え忘れのリスクがありません。

唯一考えられるのは、ログインするkubectlインスタンスを間違えてしまうことですが、このリスク低減については後述します。

## EKSクラスターのRBAC

EKSクラスターでは、KubernetesのClusterRole/ClusterRoleBinding と AWS IAMロール/IAMユーザとのマッピングが可能です。

IAMユーザにKubernetesリソースの作成・更新・削除の権限を付与したお手軽運用も可能ですが、これだと今回の課題であるコンテキスト切り替えミスのリスクを抱えることになります。

また、強い権限をkubectlインスタンスロールに限定することで、セキュリティリスクも低減できそうです。

（この辺りはIAM運用の仕方にもよると思うので一概には言えませんが）

## kubectlインスタンスへのログイン(SSM SessionManager)

kubectlインスタンスには、SSM SessionManagerでログインさせます。

SessionManagerを利用することで、以下利点があります。

* インターネットからのインバウンドが不要
* IAMユーザー/グループ単位でインスタンスへのアクセス権限管理が可能
* IAMユーザー単位でアクティビティログ（操作ログ）をセキュアに保存可能

インターネットからのインバウンドが不要であるため、プライベートサブネットヘ接続するVPN接続等の環境が構築不要です。

また、

### ログイン時メッセージで間違いに気付かせる
(SSM SessionManagerなので、厳密はログインではないかもしれませんが)

Amazon Linux2へのSSHログインの際には、デフォルトで以下のようなメッセージが表示されます。

```

       __|  __|_  )
       _|  (     /   Amazon Linux 2 AMI
      ___|\___|___|

https://aws.amazon.com/amazon-linux-2/
```

このメッセージをカスタムして、どのクラスターに対するkubectlインスタンスにログインしたのかをわかりやすくしています。

メッセージは`/etc/motd`ファイルに記述されているので、これを編集します。

```


This is  DEVELOP  kubectl instance.


```

例えば本番環境のクラスターには、以下のように警告的なメッセージにするのもいいと思います。

```


!!! WARNING !!!
This is  PRODUCTION  kubectl instance.
!!! WARNING !!!


```

もちろんこれで100%防げるわけではなく、ログイン先のインスタンスを間違えてしまう可能性は残りますが、かなり間違いに気が付きやすくなると思います。

###